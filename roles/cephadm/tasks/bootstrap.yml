---
- name: Bootstrap cephadm
  block:
  - name: Bootstrap cephadm
    vars:
      mon_ip: "{{ hostvars[inventory_hostname]['ansible_'~cephadm_public_interface].ipv4.address }}"
      monitoring_stack: "{{ '--skip-monitoring-stack' if not (cephadm_enable_monitoring | bool) else '' }}"
      dashboard: "{{ '--skip-dashboard' if not cephadm_enable_dashboard | bool else '' }}"
      firewalld: "{{ '--skip-firewalld' if not cephadm_enable_firewalld | bool else '' }}"
    command:
      cmd: >
           cephadm bootstrap
           {{ monitoring_stack }}
           {{ dashboard }}
           {{ firewalld }}
           --ssh-private-key={{ cephadm_ssh_private_key }}
           --ssh-public-key={{ cephadm_ssh_public_key }}
           --ssh-user "{{ cephadm_ssh_user }}"
           {% if cephadm_registry_url | length > 0 %}
           --registry-url={{ cephadm_registry_url }}
           --registry-username={{ cephadm_registry_username }}
           --registry-password={{ cephadm_registry_password }}
           {% endif %}
           --skip-pull
           {% if cephadm_fsid | length > 0 %}
           --fsid={{ cephadm_fsid }}
           {% endif %}
           --mon-ip={{ mon_ip }}
    become: true
    when: not cephadm_check_ceph_conf.stat.exists

  delegate_to: "{{ groups['mons'][0] }}"
  run_once: True
